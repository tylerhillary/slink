rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isNonEmptyString(value) {
      return value is string && value.size() > 0;
    }

    function isOptionalNonEmptyString(value) {
      return value == null || isNonEmptyString(value);
    }

    function isOptionalString(value) {
      return value == null || value is string;
    }

    function isOptionalTimestamp(value) {
      return value == null || value is timestamp;
    }

    function isTimestampOrServer(value) {
      return value is timestamp || value == request.time || value is map;
    }

    function isNonEmptyStringList(list) {
      return list is list && list.size() > 0 && list.size() <= 50 && list[0] is string;
    }

    function isOptionalStringList(list) {
      return list == null || (list is list && (list.size() == 0 || list[0] is string));
    }

    function hasValidPhoneDetails(details) {
      return details == null || (
        details is map &&
        details.keys().hasOnly(['e164', 'countryCode', 'nationalNumber', 'rawInput', 'international', 'display']) &&
        isOptionalNonEmptyString(details.e164) &&
        isOptionalNonEmptyString(details.countryCode) &&
        isOptionalNonEmptyString(details.nationalNumber) &&
        isOptionalString(details.rawInput) &&
        isOptionalNonEmptyString(details.international) &&
        isOptionalNonEmptyString(details.display)
      );
    }

    function hasValidTeacherNotification(notification) {
      return notification == null || (
        notification is map &&
        notification.keys().hasOnly(['status', 'createdAt', 'updatedAt', 'lastAttemptedAt', 'lastError']) &&
        isNonEmptyString(notification.status) &&
        (notification.createdAt == null || isTimestampOrServer(notification.createdAt)) &&
        (notification.updatedAt == null || isTimestampOrServer(notification.updatedAt)) &&
        (notification.lastAttemptedAt == null || isTimestampOrServer(notification.lastAttemptedAt)) &&
        isOptionalString(notification.lastError)
      );
    }

    function isPublicRegistrationCreate() {
      let data = request.resource.data;
      return data.keys().hasOnly([
          'fullName',
          'email',
          'age',
          'gender',
          'location',
          'selectedSkill',
          'status',
          'source',
          'consent',
          'createdAt',
          'phone',
          'contactPhone',
          'phoneDetails',
          'teachSkills',
          'teachSkillsIndex',
          'teacherNotification',
          'intent'
        ]) &&
        data.keys().hasAll([
          'fullName',
          'email',
          'age',
          'gender',
          'location',
          'selectedSkill',
          'status',
          'source',
          'consent',
          'teachSkills',
          'intent'
        ]) &&
        isNonEmptyString(data.fullName) &&
        data.fullName.size() >= 3 &&
        isNonEmptyString(data.email) &&
        data.email.size() > 5 &&
        data.age is int && data.age >= 13 && data.age <= 100 &&
        isNonEmptyString(data.gender) &&
        isNonEmptyString(data.location) &&
        isNonEmptyString(data.selectedSkill) &&
        data.status in ['pending', 'matched', 'archived'] &&
        isNonEmptyString(data.source) &&
        data.consent == true &&
        (data.createdAt == null || isTimestampOrServer(data.createdAt)) &&
        isOptionalNonEmptyString(data.phone) &&
        isOptionalNonEmptyString(data.contactPhone) &&
        isNonEmptyStringList(data.teachSkills) &&
        isOptionalStringList(data.teachSkillsIndex) &&
        data.intent in ['learn', 'teach', 'both'] &&
        hasValidPhoneDetails(data.phoneDetails) &&
        hasValidTeacherNotification(data.teacherNotification);
    }

    match /registrations/{registrationId} {
      allow create, read, update, delete: if true;
    }

    match /submissions/{submissionId} {
      allow create, read, update, delete: if true;
    }

    match /mailQueue/{mailId} {
      allow create, read, update, delete: if true;
    }

    function isValidSkillCreate() {
      let data = request.resource.data;
      return request.auth == null &&
        data.keys().hasOnly(['name', 'icon', 'description', 'status', 'nameLower', 'createdAt']) &&
        data.keys().hasAll(['name', 'status', 'nameLower']) &&
        isNonEmptyString(data.name) &&
        isOptionalString(data.icon) &&
        isOptionalString(data.description) &&
        isNonEmptyString(data.status) &&
        isNonEmptyString(data.nameLower) &&
        (data.createdAt == null || isTimestampOrServer(data.createdAt));
    }

    match /skills/{skillId} {
      allow read: if true;
      allow create: if isValidSkillCreate();
      allow update, delete: if false;
    }

    function isValidContactSubmission() {
      let data = request.resource.data;
      return data.keys().hasOnly(['name', 'email', 'phone', 'topic', 'subject', 'message', 'timestamp']) &&
        data.keys().hasAll(['name', 'email', 'topic', 'subject', 'message', 'timestamp']) &&
        isNonEmptyString(data.name) &&
        data.name.size() >= 3 &&
        isNonEmptyString(data.email) &&
        data.email.size() > 5 &&
        isNonEmptyString(data.topic) &&
        isNonEmptyString(data.subject) &&
        isNonEmptyString(data.message) &&
        isOptionalString(data.phone) &&
        isTimestampOrServer(data.timestamp);
    }

    match /contactSubmissions/{submissionId} {
      allow create: if isValidContactSubmission();
      allow read, update, delete: if false;
    }

    match /teachers/{teacherId} {
      allow read: if true;
      allow write: if false;
    }

    match /{document=**} {
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }
  }
}
